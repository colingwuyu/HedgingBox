# Hedging Market Reward

## Environment Loop

In `Environment` **⬄** `Actor` loop, it starts with a state observation $O_0$ generated by `Environment` and observed by `Actor`. Then `Actor` selects an action $A_0$ by taking $O_0$ into consideration. After `Environment` receives the action, it generates a reward $R_0$ to action $A_0$ and the next step state observation $O_1$. In the meantime, the environment discount $\gamma_0$ ensuing from action $A_0$ is also generated by `Environment`. This discount is applied to future rewards after $R_0$.  The cycle continues until it reaches the last state observation $O_T$ in the terminal state of episode.

## Transition Tuple

For each step, denote a transition tuple $(O_t, A_t, R_t,\gamma_t, O_{t+1})$. This tuple is a unit of data that is inserted into the replay buffer for `Learner`. Therefore `Learner` can construct learn from the data.

The following diagram demonstrates the `Environment` **⬄** `Actor` interaction and the transition tuple per actor step:

### Transition Data Diagram

<img src="../../../docs/diagrams/ACME_Dataset.png" style="max-width:100%;">

---

## Hedging Market Reward

There are two alternative formulations of the hedger's problem: the accounting P&L formulation and the cash flow formulation. We focus on the P&L formulation in our implementation.

### Accounting P&L formulation

In the accounting P&L formulation, there are three components contributing to P&L:

- P&L contributed from option position
- P&L contributed from hedging position (underlying)
- P&L contributed from trading cost for portfolio rebalance

Let's denote $H_t$ as the holding of hedging position between time $t$ to $t+1$; $S_t$ as the underlying price at time $t$.

Considering an hedging action $A_t$ at time $t$, its effect includes:

1. The hedging position change from $H_t$ to $H_{t+1}=H_t+A_t$. It causes an immediate trading cost $C_t$. Simply formulate $C_t$ as a proportion of the traded value $\kappa|S_tA_t|$.

2. The portfolio (option + hedging) P&L incurred at time $t+1$ due to the rebalance at time $t$.

The former cost happens at time $t$, whereas the P&L effect happens at time $t+1$. We can apply a discount factor on portfolio P&L in order to mitigate the time difference. For now we assume that no discounting, and formulate the reward for $A_t$ as:

$$R_t=-\kappa|S_tA_t| + (V_{t+1}-V_t) + H_t(S_{t+1}-S_t)\tag1$$

when $t<N$. Here $N$ is the last timestep before terminal state $T$ (see [Diagram](#Transition-Data-Diagram)).

$$R_N=-\kappa|S_NA_N| - \kappa|S_TH_T| + (V_T-V_N) + H_N(S_T-S_N) \tag2$$

The terminal state $T$ happens at the option expiry time. The term $\kappa|S_TH_T|$ is the trading cost of liquidating the hedging position at last.
