# Hedging Market Reward Rules

## Environment Loop

In `Environment` **⬄** `Actor` loop, it starts with a state observation <img src="https://render.githubusercontent.com/render/math?math=O_0"> generated by `Environment` and observed by `Actor`. Then `Actor` selects an action <img src="https://render.githubusercontent.com/render/math?math=A_0"> by taking <img src="https://render.githubusercontent.com/render/math?math=O_0"> into consideration. After `Environment` receives the action, it generates a reward <img src="https://render.githubusercontent.com/render/math?math=R_0"> to action <img src="https://render.githubusercontent.com/render/math?math=A_0"> and the next step state observation <img src="https://render.githubusercontent.com/render/math?math=O_1">. In the meantime, the environment discount <img src="https://render.githubusercontent.com/render/math?math=\gamma_0"> ensuing from action <img src="https://render.githubusercontent.com/render/math?math=A_0"> is also generated by `Environment`. This discount is applied to future rewards after <img src="https://render.githubusercontent.com/render/math?math=R_0">.  The cycle continues until it reaches the last state observation <img src="https://render.githubusercontent.com/render/math?math=O_N"> in the terminal state of episode.

## Transition Tuple

For each step, denote a transition tuple <img src="https://render.githubusercontent.com/render/math?math=(O_t, A_t, R_t,\gamma_t, O_{t%2B1})">. This tuple is a unit of data that is inserted into the replay buffer for `Learner`.

The following diagram demonstrates the `Environment` **⬄** `Actor` interaction and the transition tuple per actor step:

### Transition Data Diagram

<img src="../../../docs/diagrams/ACME_DataSet.png" style="max-width:100%;">

---

## Hedging Market Reward

There are two alternative formulations of the hedger's problem: the accounting P&L formulation and the cash flow formulation. We focus on the P&L formulation in our implementation.

### Accounting P&L formulation

In the accounting P&L formulation, there are three components contributing to P&L:

- P&L contributed from option position
- P&L contributed from hedging position (underlying)
- P&L contributed from trading cost for portfolio rebalance

Let's denote <img src="https://render.githubusercontent.com/render/math?math=H_t"> as the holding of hedging position between time <img src="https://render.githubusercontent.com/render/math?math=t"> to <img src="https://render.githubusercontent.com/render/math?math=t%2B1">; <img src="https://render.githubusercontent.com/render/math?math=S_t"> as the underlying price at time <img src="https://render.githubusercontent.com/render/math?math=t">.

Considering a hedging action <img src="https://render.githubusercontent.com/render/math?math=A_t=H_{t%2B1}-H_t">, which is the buy/sell shares at time at time <img src="https://render.githubusercontent.com/render/math?math=t%2B1">. its effect includes:

1. The hedging position change from <img src="https://render.githubusercontent.com/render/math?math=H_t"> to <img src="https://render.githubusercontent.com/render/math?math=H_{t%2B1}=H_t%2BA_t">. It causes a trading cost <img src="https://render.githubusercontent.com/render/math?math=C_t">. Simply formulate <img src="https://render.githubusercontent.com/render/math?math=C_t"> as a proportion of the traded value <img src="https://render.githubusercontent.com/render/math?math=\kappa|S_{t%2B1}A_t|">.

2. The portfolio (option + hedging) P&L incurred between <img src="https://render.githubusercontent.com/render/math?math=t"> and <img src="https://render.githubusercontent.com/render/math?math=t%2B1">.

By combining the two parts together, we can formulate the reward <img src="https://render.githubusercontent.com/render/math?math=R_t"> for <img src="https://render.githubusercontent.com/render/math?math=A_t"> as:

<img src="../../../docs/diagrams/pnl_formula_1.png" style="max-width:100%;">

when <img src="https://render.githubusercontent.com/render/math?math=t<N">. Here <img src="https://render.githubusercontent.com/render/math?math=N"> is the terminal state (see [Diagram](#Transition-Data-Diagram)).

For <img src="https://render.githubusercontent.com/render/math?math=t=N">:

<img src="../../../docs/diagrams/pnl_formula_2.png" style="max-width:100%;">

The terminal state <img src="https://render.githubusercontent.com/render/math?math=N"> happens at the option expiry time. The term <img src="https://render.githubusercontent.com/render/math?math=\kappa|S_NH_{N-1}|"> is the trading cost of liquidating the hedging position at last.
